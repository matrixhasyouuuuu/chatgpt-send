#!/usr/bin/env bash
set -euo pipefail

# WARNING: --no-sandbox reduces security. Use only on a trusted machine.
CHROME_BIN="${CHROME_BIN:-/usr/bin/google-chrome-stable}"

if [[ ! -x "$CHROME_BIN" ]]; then
  if command -v google-chrome-stable >/dev/null 2>&1; then
    CHROME_BIN="$(command -v google-chrome-stable)"
  elif command -v google-chrome >/dev/null 2>&1; then
    CHROME_BIN="$(command -v google-chrome)"
  elif command -v chromium >/dev/null 2>&1; then
    CHROME_BIN="$(command -v chromium)"
  elif command -v chromium-browser >/dev/null 2>&1; then
    CHROME_BIN="$(command -v chromium-browser)"
  fi
fi

if [[ ! -x "$CHROME_BIN" ]]; then
  echo "ERROR: Chrome/Chromium not found. Set CHROME_BIN or pass --chrome-path to chatgpt_send." >&2
  exit 1
fi

export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp/chatgpt-send-xdg-runtime}"
mkdir -p "$XDG_RUNTIME_DIR" >/dev/null 2>&1 || true

# In restricted environments (e.g., sandboxed agents), Chrome may not be able to
# write to ~/.config. Redirect XDG paths to writable locations.
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-/tmp/chatgpt-send-xdg-config}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-/tmp/chatgpt-send-xdg-cache}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-/tmp/chatgpt-send-xdg-state}"
mkdir -p "$XDG_CONFIG_HOME" "$XDG_CACHE_HOME" "$XDG_STATE_HOME" >/dev/null 2>&1 || true
mkdir -p "$XDG_CACHE_HOME/crashpad" >/dev/null 2>&1 || true

exec "$CHROME_BIN" \
  --no-sandbox \
  --disable-setuid-sandbox \
  --disable-dev-shm-usage \
  --disable-breakpad \
  --crash-dumps-dir="$XDG_CACHE_HOME/crashpad" \
  "$@"
